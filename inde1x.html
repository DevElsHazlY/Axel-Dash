<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <title>Axel Dash - Ultimate Particles</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: black;
            user-select: none;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #bgCanvas {
            position: absolute;
            z-index: 0;
            left: 0; top: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
        }
        #gameCanvas {
            display: block;
            margin: 0 auto;
            background: none !important;
            box-shadow: 0px 0px 15px rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 2;
        }
        #gameOver {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 500px;
            padding: 30px;
            background: linear-gradient(135deg, rgba(3, 22, 61, 0.95), rgba(10, 0, 30, 0.95));
            border: 2px solid #00ffff;
            border-radius: 20px;
            text-align: center;
            color: white;
            font-size: 2em;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.3);
            z-index: 10;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        button {
            font-family: inherit;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        button:active {
            transform: scale(0.95);
        }
        #restartBtn {
            padding: 12px 30px;
            font-size: 0.5em;
            background: linear-gradient(to right, #00ff9d, #00cc7a);
            color: #003300;
            border: none;
            border-radius: 50px;
            width: 70%;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.4);
            font-weight: bold;
        }
        #highScore, #score, #coins {
            position: absolute;
            color: white;
            opacity: 0.9;
            font-size: 1.2em;
            right: 20px;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
            z-index: 5;
            font-weight: bold;
        }
        #highScore { top: 20px; }
        #score { top: 55px;}
        #coins { top: 90px; color: #ffd700; font-size: 1.1em;}

        #startScreen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            text-align: center;
            color: white;
            display: flex;
            align-items: center; justify-content: center;
            flex-direction: column;
            font-size: 2em;
            z-index: 20;
            backdrop-filter: blur(5px);
        }
        #startScreen img {
            cursor: pointer;
            width: 90px;
            height: auto;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 10px white);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); filter: drop-shadow(0 0 10px white); }
            50% { transform: scale(1.1); filter: drop-shadow(0 0 20px #00ffff); }
            100% { transform: scale(1); filter: drop-shadow(0 0 10px white); }
        }
        #shopScreen {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(5, 10, 30, 0.98);
            text-align: center;
            color: white;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            z-index: 100;
        }
        .shop-header {
            font-size: 2em;
            margin-bottom: 20px;
            color: #ffcc00;
            text-shadow: 0 0 15px rgba(255, 204, 0, 0.5);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
            width: 100%;
        }
        .skin-container {
            display: flex; flex-wrap: wrap; justify-content: center;
            gap: 20px; margin: 20px 0;
            max-height: 70%; overflow-y: auto;
            padding: 10px;
        }
        .skin-item {
            width: 110px; height: 140px;
            background: linear-gradient(180deg, rgba(30, 50, 90, 0.8), rgba(10, 20, 40, 0.9));
            border-radius: 15px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid rgba(255,255,255,0.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .skin-item:hover {
            transform: translateY(-5px) scale(1.05);
            border-color: #00aaff;
            box-shadow: 0 10px 20px rgba(0, 170, 255, 0.3);
        }
        .skin-item.selected {
            border-color: #00ff9d;
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.5), inset 0 0 20px rgba(0, 255, 157, 0.1);
            background: linear-gradient(180deg, rgba(0, 40, 30, 0.9), rgba(0, 20, 10, 0.9));
        }
        .skin-preview {
            width: 60px; height: 60px;
            margin: 10px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        .skin-name { font-size: 1em; margin-bottom: 5px; font-weight: bold; }
        .skin-price { font-size: 0.85em; color: #ffd700; }
        .skin-owned { font-size: 0.85em; color: #00ff9d; }
        
        #backBtn, #shopBtn {
            background-color: #555;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            margin-top: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        #shopBtn {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to right, #ffcc00, #ffaa00);
            color: #332200; 
            box-shadow: 0 0 25px rgba(255, 204, 0, 0.4);
            z-index: 5;
            font-weight: bold;
        }
        #particlesCanvas {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 3; /* ŸÅŸàŸÇ ÿßŸÑŸÑÿπÿ®ÿ© */
        }
        .controls-info {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255,255,255,0.6);
            font-size: 0.7em;
            text-align: center;
            z-index: 5;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <canvas id="bgCanvas"></canvas>
    
    <div id="startScreen">
        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBmaWxsPSJ3aGl0ZSI+PHBhdGggZD0iTTI1NiA0OEMxNDEuMSA0OCA0OCAxNDEuMSA0OCAyNTZzOTMuMSAyMDggMjA4IDIwOCAyMDgtOTMuMSAyMDgtMjA4UzM3MC45IDQ4IDI1NiA0OHptLTI0IDM4NGMtMTMuMyAwLTI0LTEwLjctMjQtMjRzMTAuNy0yNCAyNC0yNCAyNCAxMC43IDI0IDI0LTEwLjcgMjQtMjQgMjR6bTMyLTE2OGMwIDE3LjctMTQuMyAzMi0zMiAzMnMtMzItMTQuMy0zMi0zMnMxNC4zLTMyIDMyLTMyIDMyIDE0LjMgMzIgMzJ6bTE2MCA2NGMwIDE3LjctMTQuMyAzMi0zMiAzMnMtMzItMTQuMy0zMi0zMnMxNC4zLTMyIDMyLTMyIDMyIDE0LjMgMzIgMzJ6Ii8+PC9zdmc+" alt="Play">
        <div style="font-weight: 800; text-shadow: 0 0 10px #00ffff; margin-bottom: 10px;">AXEL DASH</div>
        <div style="font-size: 0.5em; opacity: 0.8;">ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿ®ÿØÿ°</div>
        <div class="controls-info">ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑŸÇŸÅÿ≤ - ÿ™ÿ¨ŸÜÿ® ÿßŸÑÿπŸÇÿ®ÿßÿ™</div>
        <button id="startBtn" style="padding: 15px 40px; font-size: 0.6em; background: linear-gradient(to right, #00ff9d, #00cc7a); color: #003300; border: none; border-radius: 100px; cursor: pointer; box-shadow: 0 0 25px rgba(0, 255, 157, 0.5); margin-top: 25px; font-weight: bold;">ÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®</button>
        <button id="menuShopBtn" style="padding: 12px 30px; font-size: 0.5em; background: linear-gradient(to right, #ffcc00, #ff9900); color: #332200; border: none; border-radius: 100px; cursor: pointer; box-shadow: 0 0 20px rgba(255, 204, 0, 0.4); margin-top: 15px; font-weight: bold;">ÿßŸÑŸÖÿ™ÿ¨ÿ±</button>
    </div>

    <canvas id="gameCanvas" width="390" height="600"></canvas>
    <canvas id="particlesCanvas" width="390" height="600"></canvas>

    <div id="gameOver">
        <div style="color: #ff3333; text-shadow: 0 0 15px red; font-weight: bold;">ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÑÿπÿ®ÿ©</div>
        <div id="finalScore" style="font-size: 0.6em; margin: 10px 0;">ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©: 0</div>
        <button id="restartBtn">ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©</button>
        <button id="mainMenuBtn" style="display: block; margin-top: 5px; padding: 12px 30px; font-size: 0.5em; background: #555; color: white; border: none; border-radius: 50px; width: 70%; cursor: pointer; box-shadow: 0 5px 10px rgba(0,0,0,0.3);">ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</button>
    </div>

    <div id="highScore">ÿ£ŸÅÿ∂ŸÑ: 0</div>
    <div id="score">0</div>
    <div id="coins">ü™ô 0</div>

    <div id="shopScreen">
        <div class="shop-header">ÿßŸÑŸÖÿ™ÿ¨ÿ±</div>
        <div class="skin-container" id="skinContainer"></div>
        <button id="backBtn">ÿßŸÑÿπŸàÿØÿ©</button>
    </div>

    <script>
    // --- Geometry Dash Animated BACKGROUND ---
    const bgCanvas = document.getElementById('bgCanvas');
    const bgCtx = bgCanvas.getContext('2d');
    function resizeBgCanvas() {
      bgCanvas.width = window.innerWidth;
      bgCanvas.height = window.innerHeight;
    }
    resizeBgCanvas();
    window.addEventListener('resize', resizeBgCanvas);

    const geomLayers = [
      {speed: 0.4, size: 60, color1:'#042b66', color2:'#0646b6', alpha:1, count:7, yOffset:110, shapes:[]},
      {speed: 0.7, size: 38, color1:'#0a75da', color2:'#10cbff', alpha:0.8, count:13, yOffset:185, shapes:[]},
      {speed: 1.1, size: 22, color1:'#43e4c9', color2:'#19fdab', alpha:0.7, count:18, yOffset:260, shapes:[]},
      {speed: 1.6, size: 16, color1:'#f4d93c', color2:'#ff8800', alpha:0.52, count:25, yOffset:370, shapes:[]},
      {speed: 2.25, size: 13, color1:'#f531a4', color2:'#fc7303', alpha:0.32, count:24, yOffset:410, shapes:[]}
    ];

    function initializeGeomLayers() {
      for (const layer of geomLayers) {
        layer.shapes = [];
        for (let i = 0; i < layer.count; i++) {
          layer.shapes.push({
            x: Math.random() * bgCanvas.width,
            y: layer.yOffset + Math.random() * 70,
            w: layer.size + Math.random() * layer.size / 2,
            h: layer.size + Math.random() * layer.size / 2,
            type: Math.random() > 0.3 ? "rect" : "circle",
            angle: Math.random() * 360
          });
        }
      }
    }
    initializeGeomLayers();

    function drawBGGeometryDashStyle() {
      const grad = bgCtx.createLinearGradient(0, 0, 0, bgCanvas.height);
      grad.addColorStop(0, "#03163d");
      grad.addColorStop(1, "#1273ba");
      bgCtx.fillStyle = grad;
      bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);

      for (const layer of geomLayers) {
        for (const s of layer.shapes) {
          let g = bgCtx.createLinearGradient(s.x, s.y, s.x + s.w, s.y + s.h);
          g.addColorStop(0, layer.color1);
          g.addColorStop(1, layer.color2);

          bgCtx.save();
          bgCtx.globalAlpha = layer.alpha;
          bgCtx.translate(s.x + s.w / 2, s.y + s.h / 2);
          bgCtx.rotate((s.angle * Math.PI) / 180);
          bgCtx.translate(-s.w / 2, -s.h / 2);
          if (s.type === "rect") {
            bgCtx.fillStyle = g;
            bgCtx.fillRect(0, 0, s.w, s.h);
            bgCtx.strokeStyle = "rgba(255,255,255,0.05)";
            bgCtx.lineWidth = 2;
            bgCtx.strokeRect(0, 0, s.w, s.h);
          } else {
            let lg = bgCtx.createRadialGradient(s.w / 2, s.h / 2, 2, s.w / 2, s.h / 2, s.w / 2);
            lg.addColorStop(0, layer.color2);
            lg.addColorStop(1, layer.color1);
            bgCtx.fillStyle = lg;
            bgCtx.beginPath();
            bgCtx.arc(s.w / 2, s.h / 2, s.w / 2, 0, Math.PI * 2);
            bgCtx.fill();
          }
          bgCtx.restore();
        }
      }
    }

    function updateBGGeometryDashStyle() {
      for (const layer of geomLayers) {
        for (const s of layer.shapes) {
          s.x -= layer.speed;
          s.angle += 0.002 * layer.speed;
          if (s.x + s.w < 0) {
            s.x = bgCanvas.width + Math.random() * 50;
            s.y = layer.yOffset + Math.random() * 70;
          }
        }
      }
    }
    
    function bgLoop() {
      updateBGGeometryDashStyle();
      drawBGGeometryDashStyle();
      requestAnimationFrame(bgLoop);
    }
    bgLoop();

    // -------- ÿßŸÑŸÑÿπÿ®ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© --------
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const particlesCanvas = document.getElementById('particlesCanvas');
    const particlesCtx = particlesCanvas.getContext('2d');
    
    // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÑÿπÿ®ÿ©
    const groundHeight = 0;
    const player = {
        x: 50,
        y: canvas.height - groundHeight - 50,
        width: 50,
        height: 50,
        color: 'red',
        velocityY: 0,
        gravity: 0.7,
        jumpPower: -11,
        isJumping: false,
        wasJumping: false, // ŸÑŸÖÿπÿ±ŸÅÿ© ŸÑÿ≠ÿ∏ÿ© ÿßŸÑŸáÿ®Ÿàÿ∑
        rotation: 0,
        rotationSpeed: 0.1,
        skin: 'default'
    };

    // ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ¨ŸÑŸàÿØ
    const skins = [
        { id: 'default', name: 'ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä', color: '#ff00ff', trail: '#ff00ff', price: 0, owned: true },
        { id: 'blue', name: 'ÿßŸÑÿ£ÿ≤ÿ±ŸÇ', color: '#00ffff', trail: '#00ffff', price: 25, owned: false },
        { id: 'green', name: 'ÿßŸÑÿ£ÿÆÿ∂ÿ±', color: '#00ff9d', trail: '#00ff9d', price: 50, owned: false },
        { id: 'gold', name: 'ÿßŸÑÿ∞Ÿáÿ®Ÿä', color: '#ffd700', trail: '#ffd700', price: 100, owned: false },
        { id: 'rainbow', name: 'ŸÇŸàÿ≥ ŸÇÿ≤ÿ≠', color: 'rainbow', trail: 'rainbow', price: 200, owned: false }
    ];
    
    // ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ¨ÿ≥ŸäŸÖÿßÿ™ ÿßŸÑŸÖÿ™ÿ∑Ÿàÿ±
    let particles = [];

    // ÿØÿßŸÑÿ© ÿπÿßŸÖÿ© ŸÑÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ¨ÿ≥ŸäŸÖÿßÿ™
    function createParticle(x, y, type, color, options = {}) {
        const particle = {
            x: x,
            y: y,
            type: type,
            color: color,
            life: options.life || 30,
            maxLife: options.life || 30,
            size: options.size || 5,
            speedX: options.speedX || (Math.random() - 0.5) * 4,
            speedY: options.speedY || (Math.random() - 0.5) * 4,
            gravity: options.gravity || 0,
            alpha: 1,
            decay: options.decay || 0.95
        };
        particles.push(particle);
    }

    // ÿ¨ÿ≥ŸäŸÖÿßÿ™ ÿßŸÑÿ£ÿ´ÿ± (ÿ™ÿÆÿ±ÿ¨ ŸÖŸÜ ÿßŸÑŸÑÿßÿπÿ®)
    function createTrail() {
        if (isGameOver) return;
        const currentSkin = skins.find(s => s.id === player.skin) || skins[0];
        const isRainbow = currentSkin.trail === 'rainbow';
        const hue = isRainbow ? (Date.now() / 10) % 360 : 0;
        const color = isRainbow ? `hsl(${hue}, 100%, 60%)` : currentSkin.trail;

        // ÿ∞ŸäŸÑ ÿπÿßÿØŸä
        createParticle(
            player.x + Math.random() * player.width,
            player.y + player.height,
            'trail',
            color,
            { life: 20, size: Math.random() * 6 + 2, speedX: -5, speedY: 0, decay: 0.9 }
        );
    }

    // ÿ¨ÿ≥ŸäŸÖÿßÿ™ ÿßŸÑÿ¨ÿ±Ÿä ÿßŸÑŸÅÿÆŸÖÿ© (ÿπŸÜÿØŸÖÿß ŸäŸÉŸàŸÜ ÿπŸÑŸâ ÿßŸÑÿ£ÿ±ÿ∂)
    function createRunningParticles() {
        if (isGameOver) return;
        const currentSkin = skins.find(s => s.id === player.skin) || skins[0];
        const isRainbow = currentSkin.color === 'rainbow';
        
        for(let i=0; i<2; i++) {
             const hue = isRainbow ? (Date.now() / 5 + i * 50) % 360 : 0;
             const color = isRainbow ? `hsl(${hue}, 100%, 70%)` : adjustColor(currentSkin.color, 40);
             
             createParticle(
                player.x + Math.random() * 20, // ÿÆŸÑŸÅ ÿßŸÑŸÑÿßÿπÿ® ŸÇŸÑŸäŸÑÿßŸã
                player.y + player.height - 5,
                'run',
                color,
                { 
                    life: 40, 
                    size: Math.random() * 5 + 3, 
                    speedX: -obstacleSpeed * 0.8 + (Math.random() - 0.5), 
                    speedY: -Math.random() * 3, // ÿ™ÿ∑Ÿäÿ± ŸÑÿ£ÿπŸÑŸâ
                    gravity: 0.1,
                    decay: 0.96
                }
             );
        }
    }

    // ÿ¥ÿ±ÿßÿ±ÿ© ÿßŸÑŸáÿ®Ÿàÿ∑ ÿßŸÑÿµŸÅÿ±ÿßÿ°
    function createLandingSpark() {
        for (let i = 0; i < 15; i++) {
            createParticle(
                player.x + player.width / 2,
                player.y + player.height,
                'spark',
                '#FFFF00', // ÿ£ÿµŸÅÿ± ŸÅÿßŸÇÿπ
                { 
                    life: 15, 
                    size: Math.random() * 4 + 2, 
                    speedX: (Math.random() - 0.5) * 15, // ÿßŸÜÿ™ÿ¥ÿßÿ± ÿ£ŸÅŸÇŸä Ÿàÿßÿ≥ÿπ
                    speedY: -Math.random() * 5, // ŸÑŸÑÿ£ÿπŸÑŸâ ŸÇŸÑŸäŸÑÿßŸã
                    decay: 0.85
                }
            );
        }
    }
    
    // ÿ¨ÿ≥ŸäŸÖÿßÿ™ ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ° ÿ≠ŸàŸÑ ÿßŸÑŸÇŸàÿ©
    function createElectricEffect(targetX, targetY, targetW, targetH, color) {
        // ŸÜÿÆÿ™ÿßÿ± ŸÜŸÇÿ∑ÿ© ÿπÿ¥Ÿàÿßÿ¶Ÿäÿ© ÿ≠ŸàŸÑ ÿßŸÑŸÖÿ±ŸÉÿ≤
        const angle = Math.random() * Math.PI * 2;
        const dist = (targetW / 1.5) + Math.random() * 10;
        const px = targetX + targetW/2 + Math.cos(angle) * dist;
        const py = targetY + targetH/2 + Math.sin(angle) * dist;

        createParticle(px, py, 'electric', color, {
            life: 10,
            size: 2,
            speedX: (Math.random() - 0.5) * 2,
            speedY: (Math.random() - 0.5) * 2,
            decay: 0.8
        });
    }

    // ÿ¨ÿ≥ŸäŸÖÿßÿ™ ÿ¨ŸÖÿπ ÿßŸÑÿπŸÖŸÑÿ©
    function createCoinPickupEffect(x, y) {
        for (let i = 0; i < 10; i++) {
            createParticle(x + 10, y + 10, 'spark', '#FFD700', {
                life: 30, size: 3, speedX: (Math.random()-0.5)*10, speedY: (Math.random()-0.5)*10
            });
        }
    }

    // ÿ¨ÿ≥ŸäŸÖÿßÿ™ ÿßŸÑÿßŸÜŸÅÿ¨ÿßÿ± (ÿßŸÑŸÖŸàÿ™)
    function createExplosion(x, y) {
        for (let i = 0; i < 50; i++) {
            createParticle(x, y, 'explosion', `hsl(${Math.random() * 360}, 100%, 50%)`, {
                life: 60, size: Math.random() * 8 + 4, 
                speedX: (Math.random() - 0.5) * 15, 
                speedY: (Math.random() - 0.5) * 15,
                decay: 0.92
            });
        }
    }

    // ÿ±ÿ≥ŸÖ Ÿàÿ™ÿ≠ÿØŸäÿ´ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ¨ÿ≥ŸäŸÖÿßÿ™
    function updateAndDrawParticles() {
        particlesCtx.clearRect(0, 0, particlesCanvas.width, particlesCanvas.height);

        for (let i = particles.length - 1; i >= 0; i--) {
            const p = particles[i];
            
            particlesCtx.globalAlpha = p.alpha;
            particlesCtx.fillStyle = p.color;
            particlesCtx.beginPath();

            if (p.type === 'electric') {
                particlesCtx.rect(p.x, p.y, p.size, p.size); // ŸÖÿ±ÿ®ÿπ ÿµÿ∫Ÿäÿ± ŸÑŸÑŸÉŸáÿ±ÿ®ÿßÿ°
            } else if (p.type === 'spark') {
                particlesCtx.moveTo(p.x, p.y - p.size);
                particlesCtx.lineTo(p.x + p.size, p.y);
                particlesCtx.lineTo(p.x, p.y + p.size);
                particlesCtx.lineTo(p.x - p.size, p.y);
            } else {
                particlesCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            }
            particlesCtx.fill();

            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ
            p.x += p.speedX;
            p.y += p.speedY;
            p.speedY += p.gravity;
            p.size *= p.decay; // ÿ™ÿµÿ∫Ÿäÿ± ÿßŸÑÿ≠ÿ¨ŸÖ
            p.life--;

            if (p.life <= 0 || p.size < 0.1) {
                particles.splice(i, 1);
            }
        }
        particlesCtx.globalAlpha = 1;
    }

    // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©
    player.skin = localStorage.getItem('selectedSkin') || 'default';
    let coinCount = localStorage.getItem('axelCoins') ? parseInt(localStorage.getItem('axelCoins')) : 0;
    let highScore = localStorage.getItem('axelHighScore') ? parseInt(localStorage.getItem('axelHighScore')) : 0;
    
    const obstacles = [];
    const traps = [];
    const floatingPlatforms = [];
    const coinsArr = [];
    const powerUps = [];
    const powerUpTypes = ['speed', 'slow', 'coinMultiplier'];
    let isGameOver = false;
    let gameRunning = false;
    let score = 0;
    let obstacleSpeed = 7;
    
    let lastPowerUpTime = 0;
    const powerUpInterval = 3500;
    let activePowerUps = {};

    function playSound(type) {
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const audioCtx = new AudioContext();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'jump') {
                osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'coin') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1800, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'hit') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            } else if (type === 'powerup') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(1200, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                osc.start(); osc.stop(audioCtx.currentTime + 0.2);
            }
        } catch(e) {}
    }

    function initShop() {
        const skinContainer = document.getElementById('skinContainer');
        skinContainer.innerHTML = '';
        skins.forEach(skin => {
            const skinElement = document.createElement('div');
            skinElement.className = 'skin-item';
            if (player.skin === skin.id) skinElement.classList.add('selected');
            
            const ownedKey = `skin_owned_${skin.id}`;
            skin.owned = localStorage.getItem(ownedKey) === 'true' || skin.price === 0;
            
            const previewElement = document.createElement('div');
            previewElement.className = 'skin-preview';
            if (skin.color === 'rainbow') {
                previewElement.style.background = 'linear-gradient(45deg, #ff00ff, #00ffff, #00ff9d, #ffcc00)';
                previewElement.style.backgroundSize = '400% 400%';
                previewElement.style.animation = 'pulse 2s linear infinite';
            } else {
                previewElement.style.background = `linear-gradient(45deg, ${skin.color}, ${adjustColor(skin.color, -30)})`;
            }
            previewElement.innerHTML = '<div style="font-size: 20px; color: white;">‚ñ†</div>';
            
            const nameElement = document.createElement('div');
            nameElement.className = 'skin-name';
            nameElement.textContent = skin.name;
            
            const priceOrStatusElement = document.createElement('div');
            if (skin.owned) {
                priceOrStatusElement.className = 'skin-owned';
                priceOrStatusElement.textContent = '‚úì ŸÖŸÖŸÑŸàŸÉ';
            } else {
                priceOrStatusElement.className = 'skin-price';
                priceOrStatusElement.textContent = `${skin.price} ü™ô`;
            }
            
            skinElement.appendChild(previewElement);
            skinElement.appendChild(nameElement);
            skinElement.appendChild(priceOrStatusElement);
            
            skinElement.addEventListener('click', () => {
                if (skin.owned) {
                    player.skin = skin.id;
                    localStorage.setItem('selectedSkin', skin.id);
                    document.querySelectorAll('.skin-item').forEach(el => el.classList.remove('selected'));
                    skinElement.classList.add('selected');
                    showNotification(`ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ${skin.name}`);
                } else {
                    if (coinCount >= skin.price) {
                        coinCount -= skin.price;
                        skin.owned = true;
                        localStorage.setItem(`skin_owned_${skin.id}`, 'true');
                        localStorage.setItem('axelCoins', coinCount);
                        priceOrStatusElement.className = 'skin-owned';
                        priceOrStatusElement.textContent = '‚úì ŸÖŸÖŸÑŸàŸÉ';
                        player.skin = skin.id;
                        localStorage.setItem('selectedSkin', skin.id);
                        document.querySelectorAll('.skin-item').forEach(el => el.classList.remove('selected'));
                        skinElement.classList.add('selected');
                        document.getElementById('coins').textContent = `ü™ô ${coinCount}`;
                        showNotification(`ÿ™ŸÖ ÿ¥ÿ±ÿßÿ° ${skin.name}`);
                    } else {
                        showNotification(`ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿπŸÖŸÑÿßÿ™ ŸÉÿßŸÅŸäÿ©`);
                    }
                }
            });
            skinContainer.appendChild(skinElement);
        });
    }
    
    function showNotification(message) {
        const n = document.createElement('div');
        n.style.cssText = "position:fixed; top:20%; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:10px 20px; border-radius:20px; border:1px solid #00ff9d; z-index:200;";
        n.textContent = message;
        document.body.appendChild(n);
        setTimeout(() => { n.remove(); }, 2000);
    }
    
    function adjustColor(color, amount) {
        if (color.startsWith('#')) {
            color = color.replace('#', '');
            const num = parseInt(color, 16);
            let r = (num >> 16) + amount;
            let g = ((num >> 8) & 0x00FF) + amount;
            let b = (num & 0x0000FF) + amount;
            r = Math.min(255, Math.max(0, r)); g = Math.min(255, Math.max(0, g)); b = Math.min(255, Math.max(0, b));
            return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).padStart(6, '0')}`;
        }
        return color;
    }

    function createObstaclesAndTraps() {
        obstacles.length = 0; traps.length = 0; floatingPlatforms.length = 0; coinsArr.length = 0; powerUps.length = 0;
        
        const numObstacles = Math.floor(Math.random() * 4) + 1;
        const minGap = 300;
        let lastObstacleX = canvas.width;

        for (let i = 0; i < numObstacles; i++) {
            const obstacleWidth = 30 + Math.random() * 10;
            obstacles.push({
                x: lastObstacleX + minGap + Math.random() * 100,
                y: canvas.height - groundHeight,
                width: obstacleWidth,
                height: 30 + Math.random() * 10
            });
            lastObstacleX = obstacles[obstacles.length - 1].x;
            traps.push({
                x: lastObstacleX + Math.random() * 150 + 50,
                y: canvas.height - groundHeight - 2,
                width: obstacleWidth,
                height: 10,
                isActivated: false
            });
        }
        for (let i = 0; i < 3; i++) {
            floatingPlatforms.push({
                x: canvas.width + 200 * i,
                y: canvas.height - groundHeight - 150 - Math.random() * 100,
                width: 100,
                height: 10
            });
        }
        for (let i = 0; i < 5; i++) {
            coinsArr.push({
                x: canvas.width + Math.random() * canvas.width,
                y: canvas.height - groundHeight - 50 - Math.random() * 100,
                width: 25, height: 25 
            });
        }
        createPowerUps();
    }
    
    function applyPowerUp(type) {
        playSound('powerup');
        switch (type) {
            case 'speed': if (!activePowerUps.speed) { obstacleSpeed += 3; activePowerUps.speed = Date.now() + 8000; } break;
            case 'slow': if (!activePowerUps.slow) { obstacleSpeed = Math.max(2, obstacleSpeed - 3); activePowerUps.slow = Date.now() + 8000; } break;
            case 'coinMultiplier': if (!activePowerUps.coinMultiplier) { activePowerUps.coinMultiplier = Date.now() + 8000; } break;
        }
    }

    function updatePowerUpsLogic() {
        const now = Date.now();
        if (activePowerUps.speed && now > activePowerUps.speed) { obstacleSpeed -= 3; delete activePowerUps.speed; }
        if (activePowerUps.slow && now > activePowerUps.slow) { obstacleSpeed += 3; delete activePowerUps.slow; }
        if (activePowerUps.coinMultiplier && now > activePowerUps.coinMultiplier) { delete activePowerUps.coinMultiplier; }
    }

    function createPowerUps() {
        if (Date.now() - lastPowerUpTime >= powerUpInterval) {
            const type = powerUpTypes[Math.floor(Math.random() * powerUpTypes.length)];
            powerUps.push({
                x: canvas.width + Math.random() * canvas.width,
                y: canvas.height - groundHeight - 100 - Math.random() * 150,
                width: 30, height: 30,
                type: type,
                color: getColorForPowerUp(type)
            });
            lastPowerUpTime = Date.now();
        }
    }

    function getColorForPowerUp(type) {
        switch (type) {
            case 'speed': return '#FF3333'; 
            case 'slow': return '#3388FF'; 
            case 'coinMultiplier': return '#33FF33'; 
            default: return 'white';
        }
    }

    function drawPlayer() {
        ctx.save();
        ctx.translate(player.x + player.width / 2, player.y + player.height / 2);
        ctx.rotate(player.rotation);
        ctx.translate(-player.width / 2, -player.height / 2);
        
        const currentSkin = skins.find(s => s.id === player.skin) || skins[0];
        const isRainbow = currentSkin.color === 'rainbow';
        
        ctx.shadowColor = currentSkin.color === 'rainbow' ? '#ffffff' : currentSkin.color;
        ctx.shadowBlur = 15;

        if (isRainbow) {
            const hue = (Date.now() / 50) % 360;
            ctx.fillStyle = `hsl(${hue}, 100%, 60%)`;
        } else {
            const gradient = ctx.createLinearGradient(0, 0, player.width, player.height);
            gradient.addColorStop(0, currentSkin.color);
            gradient.addColorStop(1, adjustColor(currentSkin.color, -30));
            ctx.fillStyle = gradient;
        }
        ctx.fillRect(0, 0, player.width, player.height);

        // ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸàÿ¨Ÿá ŸàÿßŸÑÿ≠ÿØŸàÿØ
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.9)';
        ctx.lineWidth = 2;
        ctx.strokeRect(2, 2, player.width - 4, player.height - 4);

        ctx.fillStyle = 'white';
        ctx.fillRect(10, 15, 8, 8); // ÿπŸäŸÜ Ÿäÿ≥ÿßÿ±
        ctx.fillRect(32, 15, 8, 8); // ÿπŸäŸÜ ŸäŸÖŸäŸÜ
        
        if (!player.isJumping) {
            ctx.beginPath();
            ctx.arc(player.width / 2, 32, 8, 0, Math.PI); // ŸÅŸÖ ŸÖÿ®ÿ™ÿ≥ŸÖ
            ctx.stroke();
        } else {
            ctx.fillRect(15, 32, 20, 3); // ŸÅŸÖ ÿ¨ÿßÿØ ŸÅŸä ÿßŸÑŸÇŸÅÿ≤
        }

        ctx.restore();
        ctx.shadowBlur = 0;
    }

    // ÿ±ÿ≥ŸÖ ÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑŸÇŸàÿ© (ÿ®ÿØŸÑ ÿßŸÑŸÖÿ±ÿ®ÿπ)
    function drawPowerUpShape(ctx, p) {
        ctx.save();
        ctx.translate(p.x + p.width/2, p.y + p.height/2);
        
        // ÿ™ÿ£ÿ´Ÿäÿ± ŸÜÿ®ÿ∂ ÿ®ÿ≥Ÿäÿ∑
        const scale = 1 + Math.sin(Date.now() / 200) * 0.1;
        ctx.scale(scale, scale);
        
        ctx.shadowColor = p.color;
        ctx.shadowBlur = 20;
        ctx.fillStyle = p.color;
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 2;

        if (p.type === 'speed') {
            // ÿ±ÿ≥ŸÖ ÿµÿßÿπŸÇÿ©
            ctx.beginPath();
            ctx.moveTo(5, -15);
            ctx.lineTo(-5, 0);
            ctx.lineTo(2, 0);
            ctx.lineTo(-2, 15);
            ctx.lineTo(8, -5);
            ctx.lineTo(0, -5);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        } else if (p.type === 'slow') {
            // ÿ±ÿ≥ŸÖ ÿ≥ÿßÿπÿ© ÿ±ŸÖŸÑŸäÿ© / ÿØÿ±ÿπ
            ctx.beginPath();
            ctx.moveTo(-10, -12);
            ctx.lineTo(10, -12);
            ctx.lineTo(0, 0);
            ctx.lineTo(10, 12);
            ctx.lineTo(-10, 12);
            ctx.lineTo(0, 0);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        } else if (p.type === 'coinMultiplier') {
            // ÿ±ÿ≥ŸÖ ÿ¨ŸàŸáÿ±ÿ©/ŸÖÿßÿ≥ÿ©
            ctx.beginPath();
            ctx.moveTo(0, -15);
            ctx.lineTo(12, 0);
            ctx.lineTo(0, 15);
            ctx.lineTo(-12, 0);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        }
        
        ctx.restore();
    }

    function drawObstaclesAndTraps() {
        // ÿßŸÑÿπŸàÿßÿ¶ŸÇ
        ctx.fillStyle = '#ffffff';
        ctx.shadowColor = '#000'; ctx.shadowBlur = 5;
        obstacles.forEach(obstacle => {
            ctx.beginPath();
            ctx.moveTo(obstacle.x, obstacle.y);
            ctx.lineTo(obstacle.x + obstacle.width / 2, obstacle.y - obstacle.height);
            ctx.lineTo(obstacle.x + obstacle.width, obstacle.y);
            ctx.closePath();
            ctx.fill();
            // ÿ™ŸÅÿßÿµŸäŸÑ ŸÑŸÑÿπÿßÿ¶ŸÇ
            ctx.strokeStyle = '#aaa';
            ctx.lineWidth = 1;
            ctx.stroke();
        });
        ctx.shadowBlur = 0;

        // ÿßŸÑŸÖÿµÿßÿ¶ÿØ
        ctx.fillStyle = '#ff4400';
        traps.forEach(trap => {
            ctx.fillRect(trap.x, trap.y - trap.height, trap.width, trap.height);
            // ÿ£ÿ≥ŸÜÿßŸÜ ÿßŸÑŸÖÿµŸäÿØÿ©
            ctx.beginPath();
            for(let i=0; i<trap.width; i+=5) {
                ctx.moveTo(trap.x + i, trap.y - trap.height);
                ctx.lineTo(trap.x + i + 2.5, trap.y - trap.height - 5);
                ctx.lineTo(trap.x + i + 5, trap.y - trap.height);
            }
            ctx.strokeStyle = '#ff0000';
            ctx.stroke();
        });

        // ÿßŸÑŸÖŸÜÿµÿßÿ™
        ctx.fillStyle = '#88ccff';
        floatingPlatforms.forEach(platform => {
            ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.fillRect(platform.x, platform.y, platform.width, platform.height/2);
            ctx.fillStyle = '#88ccff';
        });

        // ÿßŸÑÿπŸÖŸÑÿßÿ™
        coinsArr.forEach(coin => {
            ctx.save();
            ctx.translate(coin.x + coin.width/2, coin.y + coin.height/2);
            ctx.rotate(Date.now() / 300);
            ctx.fillStyle = '#FFD700';
            ctx.shadowColor = '#FFD700';
            ctx.shadowBlur = 10;
            ctx.beginPath();
            ctx.arc(0, 0, coin.width/2, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#FFF';
            ctx.font = 'bold 15px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('$', 0, 1);
            ctx.restore();
        });

        // ÿßŸÑŸÇŸàŸâ
        powerUps.forEach(powerUp => {
            // ÿ™ŸàŸÑŸäÿØ ÿ¨ÿ≥ŸäŸÖÿßÿ™ ŸÉŸáÿ±ÿ®ÿßÿ° ÿ≠ŸàŸÑ ÿßŸÑŸÇŸàÿ©
            if (Math.random() > 0.5) {
                createElectricEffect(powerUp.x, powerUp.y, powerUp.width, powerUp.height, powerUp.color);
            }
            drawPowerUpShape(ctx, powerUp);
        });
    }

    function updatePlayer() {
        if (isGameOver) return;

        player.y += player.velocityY;
        player.velocityY += player.gravity;

        let onPlatform = false;
        floatingPlatforms.forEach(platform => {
            if (player.x < platform.x + platform.width &&
                player.x + player.width > platform.x &&
                player.y + player.height > platform.y &&
                player.y + player.height <= platform.y + platform.height + player.velocityY + 5) {
                if (player.velocityY >= 0) {
                    player.y = platform.y - player.height;
                    player.velocityY = 0;
                    player.isJumping = false;
                    player.rotation = 0;
                    onPlatform = true;
                }
            }
        });

        if (!onPlatform && player.y > canvas.height - player.height - groundHeight) {
            player.y = canvas.height - player.height - groundHeight;
            player.velocityY = 0;
            player.isJumping = false;
            player.rotation = 0;
        }

        // ŸÖŸÜÿ∑ŸÇ ÿßŸÑÿ¥ÿ±ÿßÿ±ÿ© ÿπŸÜÿØ ÿßŸÑŸáÿ®Ÿàÿ∑
        if (player.isJumping) {
            player.wasJumping = true;
        } else {
            if (player.wasJumping) {
                // ŸÑÿ≠ÿ∏ÿ© ÿßŸÑŸáÿ®Ÿàÿ∑
                createLandingSpark();
                player.wasJumping = false;
            }
            // ÿßŸÑŸÑÿßÿπÿ® Ÿäÿ±ŸÉÿ∂ ÿπŸÑŸâ ÿßŸÑÿ£ÿ±ÿ∂
            createRunningParticles();
        }

        if (player.isJumping) {
            player.rotation += player.rotationSpeed;
            if (Math.random() > 0.5) createTrail();
        }

        // ÿßŸÑÿßÿµÿ∑ÿØÿßŸÖÿßÿ™
        obstacles.forEach(obstacle => {
            // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿØŸÇÿ© ÿßŸÑÿßÿµÿ∑ÿØÿßŸÖ (Hitbox ÿ£ÿµÿ∫ÿ± ŸÇŸÑŸäŸÑÿßŸã ŸÖŸÜ ÿßŸÑÿ±ÿ≥ŸÖ)
            if (player.x + 5 < obstacle.x + obstacle.width &&
                player.x + player.width - 5 > obstacle.x &&
                player.y + 5 < obstacle.y &&
                player.y + player.height - 5 > obstacle.y - obstacle.height) {
                gameOver();
            }
        });

        traps.forEach(trap => {
            if (player.x < trap.x + trap.width &&
                player.x + player.width > trap.x &&
                player.y + player.height >= trap.y - trap.height &&
                player.y + player.height < trap.y + 10) {
                if (!trap.isActivated) {
                    trap.isActivated = true;
                    player.velocityY = player.jumpPower * 1.5; 
                    player.isJumping = true;
                    playSound('jump');
                }
            } else { if (trap.isActivated) trap.isActivated = false; }
        });

        coinsArr.forEach((coin, index) => {
            if (player.x < coin.x + coin.width &&
                player.x + player.width > coin.x &&
                player.y < coin.y + coin.height &&
                player.y + player.height > coin.y) {
                coinCount += (activePowerUps.coinMultiplier ? 2 : 1);
                createCoinPickupEffect(coin.x, coin.y);
                playSound('coin');
                document.getElementById('coins').textContent = `ü™ô ${coinCount}`;
                localStorage.setItem('axelCoins', coinCount);
                coinsArr.splice(index, 1);
            }
        });

        powerUps.forEach((powerUp, index) => {
            if (player.x < powerUp.x + powerUp.width &&
                player.x + player.width > powerUp.x &&
                player.y < powerUp.y + powerUp.height &&
                player.y + player.height > powerUp.y) {
                applyPowerUp(powerUp.type);
                // ÿßŸÜŸÅÿ¨ÿßÿ± ÿ®ŸÑŸàŸÜ ÿßŸÑŸÇŸàÿ©
                for(let k=0; k<20; k++) {
                    createParticle(powerUp.x+15, powerUp.y+15, 'spark', powerUp.color, {life:40, speedX:(Math.random()-0.5)*10, speedY:(Math.random()-0.5)*10});
                }
                powerUps.splice(index, 1);
            }
        });
    }

    function updateObstaclesAndTraps() {
        if (isGameOver) return;
        
        const move = (arr) => {
            arr.forEach(obj => {
                obj.x -= obstacleSpeed;
                if (obj.x < -100) {
                    // ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿØŸàŸäÿ±
                    obj.x = canvas.width + Math.random() * 300 + 100;
                    if(obj.y !== undefined && obj.height === undefined) { // ŸÑŸÑŸÖŸÜÿµÿßÿ™
                         obj.y = canvas.height - groundHeight - 150 - Math.random() * 100;
                    }
                    if(obj.type) { // ŸÑŸÑŸÇŸàŸâ ŸàÿßŸÑÿπŸÖŸÑÿßÿ™
                         obj.y = canvas.height - groundHeight - 50 - Math.random() * 150;
                    }
                }
            });
        };

        // ÿ™ÿ≠ÿØŸäÿ´ ŸäÿØŸàŸä ŸÑŸÑÿπŸàÿßÿ¶ŸÇ ŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©
        obstacles.forEach(obstacle => {
            obstacle.x -= obstacleSpeed;
            if (obstacle.x < -obstacle.width) {
                obstacle.x = canvas.width + Math.random() * 200 + 100;
                score++;
                if (score % 10 === 0) obstacleSpeed += 0.5;
            }
        });

        traps.forEach(t => { t.x -= obstacleSpeed; if(t.x < -t.width) t.x = canvas.width + Math.random()*200+100; });
        move(floatingPlatforms);
        move(coinsArr);
        move(powerUps);
    }

    function jump() {
        if (!player.isJumping && !isGameOver && gameRunning) { 
            player.velocityY = player.jumpPower;
            player.isJumping = true;
            playSound('jump');
            
            // ÿ¨ÿ≥ŸäŸÖÿßÿ™ ÿπŸÜÿØ ÿßŸÑŸÇŸÅÿ≤ (ÿ∫ÿ®ÿßÿ± ÿ£ÿ®Ÿäÿ∂)
            for(let i=0; i<5; i++) {
                createParticle(player.x + player.width/2, player.y + player.height, 'dust', '#fff', {
                    life: 20, size: 5, speedY: 2, speedX: (Math.random()-0.5)*5
                });
            }
        }
    }

    function handleTouch(event) {
        if (gameRunning && !isGameOver) { 
            event.preventDefault();
            jump();
        }
    }
    
    function updateHighScore() {
        if (score > highScore) {
            highScore = score;
            localStorage.setItem('axelHighScore', highScore);
            document.getElementById('highScore').textContent = `ÿ£ŸÅÿ∂ŸÑ: ${highScore}`;
        }
    }

    function gameOver() {
        isGameOver = true;
        gameRunning = false;
        createExplosion(player.x + player.width / 2, player.y + player.height / 2);
        playSound('hit');
        updateHighScore();
        
        document.getElementById('finalScore').textContent = `ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©: ${score}`;
        document.getElementById('gameOver').style.display = 'flex';
    }
    
    function goToMainMenu() {
        document.getElementById('gameOver').style.display = 'none';
        document.getElementById('startScreen').style.display = 'flex';
        resetGameVars();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particlesCtx.clearRect(0, 0, particlesCanvas.width, particlesCanvas.height);
        document.getElementById('score').textContent = `${score}`;
        document.getElementById('coins').textContent = `ü™ô ${coinCount}`;
    }

    function resetGameVars() {
        isGameOver = false;
        gameRunning = false;
        player.x = 50;
        player.y = canvas.height - groundHeight - 50;
        player.velocityY = 0;
        player.isJumping = false;
        player.rotation = 0;
        score = 0;
        obstacleSpeed = 7;
        activePowerUps = {};
        particles = [];
    }

    function restartGame() {
        resetGameVars();
        gameRunning = true;
        createObstaclesAndTraps();
        document.getElementById('score').textContent = `${score}`;
        document.getElementById('coins').textContent = `ü™ô ${coinCount}`;
        document.getElementById('gameOver').style.display = 'none';
        gameLoop();
    }

    function gameLoop() {
        if (isGameOver) {
             // ÿßÿ≥ÿ™ŸÖÿ±ÿßÿ± ÿ±ÿ≥ŸÖ ÿßŸÑÿ¨ÿ≥ŸäŸÖÿßÿ™ (ŸÖÿ´ŸÑ ÿßŸÑÿßŸÜŸÅÿ¨ÿßÿ±) ÿ≠ÿ™Ÿâ ÿ®ÿπÿØ ÿßŸÑÿÆÿ≥ÿßÿ±ÿ©
             updateAndDrawParticles();
             if(particles.length > 0) requestAnimationFrame(gameLoop);
             return;
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        updatePlayer();
        updateObstaclesAndTraps();
        updatePowerUpsLogic();
        createPowerUps();
        
        drawPlayer();
        drawObstaclesAndTraps();
        
        updateAndDrawParticles(); // ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ¨ÿØŸäÿØ ŸÑŸÑÿ¨ÿ≥ŸäŸÖÿßÿ™

        document.getElementById('score').textContent = `${score}`;
        requestAnimationFrame(gameLoop);
    }

    function startGame() {
        document.getElementById('startScreen').style.display = 'none';
        gameRunning = true;
        isGameOver = false;
        createObstaclesAndTraps();
        gameLoop();
    }

    function initUI() {
        document.getElementById('highScore').textContent = `ÿ£ŸÅÿ∂ŸÑ: ${highScore}`;
        document.getElementById('score').textContent = `${score}`;
        document.getElementById('coins').textContent = `ü™ô ${coinCount}`;
        skins.forEach(skin => {
            const ownedKey = `skin_owned_${skin.id}`;
            skin.owned = localStorage.getItem(ownedKey) === 'true' || skin.price === 0;
        });
    }

    document.getElementById('startBtn').addEventListener('click', startGame); 
    document.getElementById('startScreen').querySelector('img').addEventListener('click', startGame);
    document.getElementById('restartBtn').addEventListener('click', restartGame);
    document.getElementById('mainMenuBtn').addEventListener('click', goToMainMenu);

    const openShop = () => {
        document.getElementById('startScreen').style.display = 'none';
        document.getElementById('gameOver').style.display = 'none';
        document.getElementById('shopScreen').style.display = 'flex';
        initShop();
    };
    
    document.getElementById('menuShopBtn').addEventListener('click', openShop); 
    
    document.getElementById('backBtn').addEventListener('click', () => {
        document.getElementById('shopScreen').style.display = 'none';
        document.getElementById('startScreen').style.display = 'flex';
    });
    
    document.addEventListener('touchstart', handleTouch, {passive: false});
    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space') jump();
    });

    window.addEventListener('load', () => {
        initUI();
    });
    </script>
</body>
</html>
